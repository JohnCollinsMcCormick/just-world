<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Just World — Mic→Pitch→5-Ratio Bank (Fine‑Tuned)</title>
<style>
  :root { --bg:#0c0f14; --panel:#141926; --ink:#e9eef7; --muted:#9aa4b5; --accent:#9a7bff; --warn:#ffb86b; }
  *{box-sizing:border-box;font:500 16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  body{margin:0;background:var(--bg);color:var(--ink);padding:22px}
  .wrap{max-width:1100px;margin:auto;display:grid;gap:16px}
  .grid{display:grid;gap:12px}
  .cols{display:grid;gap:12px}
  @media(min-width:980px){.cols{grid-template-columns:1.1fr 1fr}}
  .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px}
  h1{margin:0 0 6px;font-size:22px}
  h2{margin:0 0 8px;font-size:18px;color:var(--muted)}
  button{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;background:var(--accent);color:#0b0620;font-weight:700}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,.2);color:var(--ink)}
  .row{display:grid;grid-template-columns:190px 1fr auto;gap:10px;align-items:center}
  .smallrow{display:grid;grid-template-columns:140px 1fr auto;gap:10px;align-items:center}
  input[type=range]{width:100%}
  input[type=number]{width:110px;background:#0e1320;border:1px solid rgba(255,255,255,.12);border-radius:8px;color:var(--ink);padding:6px 8px}
  select{background:#0e1320;border:1px solid rgba(255,255,255,.12);border-radius:8px;color:var(--ink);padding:6px 8px}
  label{color:var(--ink)}
  .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .pill{padding:8px 10px;border-radius:999px;background:#0e1320;color:var(--muted);display:inline-block}
  .tiny{font-size:12px;color:var(--muted)}
  .freqs{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
  .grid-5{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
  .vcard{background:#0f1422;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px}
  canvas{width:100%;height:160px;background:#0a0f19;border-radius:10px;border:1px solid rgba(255,255,255,.06)}
  .warn{color:var(--warn)}
</style>

<div class="wrap">
  <div class="card">
    <h1>Just World — Mic → Pitch → 5 Tuned Oscillators</h1>
    <div class="tiny">Ratios default: 9/8, 5/4, 4/3, 25/8, 2/1 • Add pans, per‑osc levels, transpose, compressor safety, and a simple scope.</div>
    <div class="grid">
      <div class="row">
        <span>Transport</span>
        <div>
          <button id="start">Start</button>
          <button id="stop" class="ghost" disabled>Stop</button>
        </div>
        <span id="status" class="pill">idle</span>
      </div>
      <div class="row">
        <label for="gain">Master Gain</label>
        <input id="gain" type="range" min="0" max="1" step="0.001" value="0.3" />
        <span class="mono" id="gainVal">0.30</span>
      </div>
      <div class="row">
        <label for="smooth">Pitch Smoothing (EMA)</label>
        <input id="smooth" type="range" min="0" max="0.99" step="0.01" value="0.6" />
        <span class="mono" id="smoothVal">0.60</span>
      </div>
      <div class="row">
        <label for="gate">Gate Threshold (RMS)</label>
        <input id="gate" type="range" min="0.001" max="0.2" step="0.001" value="0.02" />
        <span class="mono" id="gateVal">0.020</span>
      </div>
      <div class="row">
        <label for="attack">Gate Attack (ms)</label>
        <input id="attack" type="range" min="0" max="200" step="1" value="25" />
        <span class="mono" id="attackVal">25</span>
      </div>
      <div class="row">
        <label for="release">Gate Release (ms)</label>
        <input id="release" type="range" min="0" max="1000" step="5" value="220" />
        <span class="mono" id="releaseVal">220</span>
      </div>
    </div>
  </div>

  <div class="cols">
    <div class="card">
      <h2>Pitch & Tuning</h2>
      <div class="grid">
        <div class="row">
          <label for="transpose">Transpose (semitones)</label>
          <input id="transpose" type="range" min="-24" max="24" step="1" value="0">
          <span class="mono" id="transposeVal">0</span>
        </div>
        <div class="row">
          <label for="octClamp">Clamp Base Octave</label>
          <select id="octClamp">
            <option value="none" selected>none</option>
            <option value="low">~100–400 Hz</option>
            <option value="mid">~200–800 Hz</option>
            <option value="hi">~400–1600 Hz</option>
          </select>
          <span class="tiny">Keeps tracked base in a range by doubling/halving.</span>
        </div>
        <div class="row">
          <span>Freeze Pitch</span>
          <div>
            <button id="freeze" class="ghost">Hold</button>
            <button id="unfreeze" class="ghost" disabled>Release</button>
          </div>
          <span class="tiny">Capture current pitch and ignore mic until released.</span>
        </div>

        <div class="card">
          <div>Base frequency: <span class="mono" id="baseHz">—</span> Hz • RMS: <span class="mono" id="rmsVal">—</span></div>
          <div class="freqs tiny">
            <div>R1: <span class="mono" id="f1">—</span></div>
            <div>R2: <span class="mono" id="f2">—</span></div>
            <div>R3: <span class="mono" id="f3">—</span></div>
            <div>R4: <span class="mono" id="f4">—</span></div>
            <div>R5: <span class="mono" id="f5">—</span></div>
          </div>
        </div>

        <div class="grid-5">
          <div class="vcard">
            <div class="tiny">Ratio 1</div>
            <input id="r1" type="number" step="0.001" value="1.125">
            <div class="smallrow"><label>Pan</label><input id="pan1" type="range" min="-1" max="1" step="0.01" value="-0.8"><span class="mono" id="pan1v">-0.80</span></div>
            <div class="smallrow"><label>Level</label><input id="lvl1" type="range" min="0" max="1" step="0.01" value="0.25"><span class="mono" id="lvl1v">0.25</span></div>
            <div><label><input id="m1" type="checkbox" checked> Mute</label></div>
          </div>
          <div class="vcard">
            <div class="tiny">Ratio 2</div>
            <input id="r2" type="number" step="0.001" value="1.25">
            <div class="smallrow"><label>Pan</label><input id="pan2" type="range" min="-1" max="1" step="0.01" value="-0.4"><span class="mono" id="pan2v">-0.40</span></div>
            <div class="smallrow"><label>Level</label><input id="lvl2" type="range" min="0" max="1" step="0.01" value="0.22"><span class="mono" id="lvl2v">0.22</span></div>
            <div><label><input id="m2" type="checkbox"> Mute</label></div>
          </div>
          <div class="vcard">
            <div class="tiny">Ratio 3</div>
            <input id="r3" type="number" step="0.001" value="1.333">
            <div class="smallrow"><label>Pan</label><input id="pan3" type="range" min="-1" max="1" step="0.01" value="0"><span class="mono" id="pan3v">0.00</span></div>
            <div class="smallrow"><label>Level</label><input id="lvl3" type="range" min="0" max="1" step="0.01" value="0.20"><span class="mono" id="lvl3v">0.20</span></div>
            <div><label><input id="m3" type="checkbox"> Mute</label></div>
          </div>
          <div class="vcard">
            <div class="tiny">Ratio 4</div>
            <input id="r4" type="number" step="0.001" value="3.125">
            <div class="smallrow"><label>Pan</label><input id="pan4" type="range" min="-1" max="1" step="0.01" value="0.4"><span class="mono" id="pan4v">0.40</span></div>
            <div class="smallrow"><label>Level</label><input id="lvl4" type="range" min="0" max="1" step="0.01" value="0.18"><span class="mono" id="lvl4v">0.18</span></div>
            <div><label><input id="m4" type="checkbox"> Mute</label></div>
          </div>
          <div class="vcard">
            <div class="tiny">Ratio 5</div>
            <input id="r5" type="number" step="0.001" value="2.0">
            <div class="smallrow"><label>Pan</label><input id="pan5" type="range" min="-1" max="1" step="0.01" value="0.8"><span class="mono" id="pan5v">0.80</span></div>
            <div class="smallrow"><label>Level</label><input id="lvl5" type="range" min="0" max="1" step="0.01" value="0.16"><span class="mono" id="lvl5v">0.16</span></div>
            <div><label><input id="m5" type="checkbox"> Mute</label></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Scope & Master Safety</h2>
      <div class="tiny">Simple oscilloscope of mic input. A DynamicsCompressor on the master protects from spikes.</div>
      <canvas id="scope" width="900" height="160"></canvas>
      <div class="grid">
        <div class="row">
          <label for="compThr">Compressor Threshold (dB)</label>
          <input id="compThr" type="range" min="-60" max="0" step="1" value="-16">
          <span class="mono" id="compThrVal">-16</span>
        </div>
        <div class="row">
          <label for="compRatio">Compressor Ratio</label>
          <input id="compRatio" type="range" min="1" max="20" step="1" value="8">
          <span class="mono" id="compRatioVal">8</span>
        </div>
        <div class="row">
          <label for="compKnee">Knee</label>
          <input id="compKnee" type="range" min="0" max="40" step="1" value="6">
          <span class="mono" id="compKneeVal">6</span>
        </div>
        <div class="row">
          <label for="compAtk">Comp Attack (s)</label>
          <input id="compAtk" type="range" min="0.001" max="0.25" step="0.001" value="0.01">
          <span class="mono" id="compAtkVal">0.010</span>
        </div>
        <div class="row">
          <label for="compRel">Comp Release (s)</label>
          <input id="compRel" type="range" min="0.01" max="1.0" step="0.01" value="0.12">
          <span class="mono" id="compRelVal">0.12</span>
        </div>
      </div>
    </div>
  </div>

  <div class="card tiny">
    Tip: if tracking jumps around, increase <em>Pitch Smoothing</em> and use <em>Clamp Base Octave</em> to keep the base band-limited. The ratios are editable; set them to 9/8, 5/4, 4/3, 25/8, 2/1 for your default.
  </div>
</div>

<script>
(() => {
  const $ = id => document.getElementById(id);
  const fmt = (n, d=2) => isFinite(n) ? Number(n).toFixed(d) : "—";

  let ctx, micNode, analyser, scriptTimer, scopeTimer;
  let master, gateGain, comp, oscillators = [], panNodes = [], oscGains = [];
  let started = false;
  let frozen = false;
  let frozenHz = 0;

  const ratioInputs = [ $('r1'), $('r2'), $('r3'), $('r4'), $('r5') ];
  const panInputs   = [ $('pan1'), $('pan2'), $('pan3'), $('pan4'), $('pan5') ];
  const lvlInputs   = [ $('lvl1'), $('lvl2'), $('lvl3'), $('lvl4'), $('lvl5') ];
  const muteInputs  = [ $('m1'), $('m2'), $('m3'), $('m4'), $('m5') ];
  const panVals     = [ $('pan1v'), $('pan2v'), $('pan3v'), $('pan4v'), $('pan5v') ];
  const lvlVals     = [ $('lvl1v'), $('lvl2v'), $('lvl3v'), $('lvl4v'), $('lvl5v') ];

  panInputs.forEach((el,i)=> el.oninput = e => { panVals[i].textContent = Number(e.target.value).toFixed(2); if (panNodes[i]) panNodes[i].pan.value = Number(e.target.value);} );
  lvlInputs.forEach((el,i)=> el.oninput = e => { lvlVals[i].textContent = Number(e.target.value).toFixed(2); if (oscGains[i]) oscGains[i].gain.value = Number(e.target.value);} );

  let gateOpen = false, gateTarget = 0;
  function setGate(open, now) {
    gateTarget = open ? 1 : 0;
    const a = Number($('attack').value)/1000;
    const r = Number($('release').value)/1000;
    gateGain.gain.cancelScheduledValues(now);
    gateGain.gain.setValueAtTime(gateGain.gain.value, now);
    gateGain.gain.linearRampToValueAtTime(gateTarget, now + (open ? a : r));
    gateOpen = open;
  }

  function detectPitchACF(buf, sampleRate) {
    const size = buf.length;
    let rms = 0;
    for (let i=0;i<size;i++) rms += buf[i]*buf[i];
    rms = Math.sqrt(rms/size);

    const thr = Number($('gate').value);
    if (rms < thr) return { freq: 0, rms };

    const corr = new Float32Array(size);
    for (let lag=0; lag<size; lag++) {
      let sum = 0;
      for (let i=0; i<size-lag; i++) sum += buf[i]*buf[i+lag];
      corr[lag] = sum;
    }

    let d = 0; while (d < size-1 && corr[d] > corr[d+1]) d++;
    let peak = -1, peakLag = -1;
    for (let i=d; i<size-1; i++) {
      if (corr[i] > peak) { peak = corr[i]; peakLag = i; }
    }
    if (peakLag <= 0) return { freq: 0, rms };

    const x1 = peakLag-1, x2 = peakLag, x3 = peakLag+1;
    if (x3 >= size) return { freq: sampleRate/peakLag, rms };
    const y1 = corr[x1], y2 = corr[x2], y3 = corr[x3];
    const denom = (y1 - 2*y2 + y3);
    const shift = denom ? 0.5*(y1 - y3)/denom : 0;
    const lag = peakLag + shift;

    const freq = sampleRate / lag;
    return { freq, rms };
  }

  let smoothHz = 0;
  function smooth(value) {
    const alpha = Number($('smooth').value);
    if (!isFinite(smoothHz) || smoothHz === 0) smoothHz = value;
    smoothHz = alpha * smoothHz + (1 - alpha) * value;
    return smoothHz;
  }

  function clampOct(base) {
    const mode = $('octClamp').value;
    if (mode === 'none' || base <= 0) return base;
    let low=50, hi=20000;
    if (mode === 'low') { low = 100; hi = 400; }
    else if (mode === 'mid') { low = 200; hi = 800; }
    else if (mode === 'hi') { low = 400; hi = 1600; }
    while (base > hi) base /= 2;
    while (base > 0 && base < low) base *= 2;
    return base;
  }

  function updateUI(base, freqs, rms) {
    $('baseHz').textContent = fmt(base, 2);
    $('rmsVal').textContent = fmt(rms, 3);
    ['f1','f2','f3','f4','f5'].forEach((id, i) => $(id).textContent = fmt(freqs[i], 2));
  }

  async function start() {
    if (started) return;
    started = true;
    $('status').textContent = 'starting…';
    $('start').disabled = true; $('stop').disabled = false;

    ctx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: "interactive" });
    const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation:false, noiseSuppression:false, autoGainControl:false } });
    micNode = ctx.createMediaStreamSource(stream);

    analyser = ctx.createAnalyser();
    analyser.fftSize = 2048;
    analyser.smoothingTimeConstant = 0.0;

    master = ctx.createGain();
    master.gain.value = Number($('gain').value);

    comp = ctx.createDynamicsCompressor();
    comp.threshold.value = Number($('compThr').value);
    comp.ratio.value = Number($('compRatio').value);
    comp.knee.value = Number($('compKnee').value);
    comp.attack.value = Number($('compAtk').value);
    comp.release.value = Number($('compRel').value);

    gateGain = ctx.createGain();
    gateGain.gain.value = 0;

    for (let i=0;i<5;i++) {
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      const p = new StereoPannerNode(ctx, { pan: Number(panInputs[i].value) });
      const g = ctx.createGain();
      g.gain.value = Number(lvlInputs[i].value);
      osc.connect(g).connect(p).connect(gateGain);
      osc.start();
      oscillators.push(osc);
      panNodes.push(p);
      oscGains.push(g);
    }

    gateGain.connect(comp).connect(master).connect(ctx.destination);
    micNode.connect(analyser);

    const buf = new Float32Array(analyser.fftSize);

    $('status').textContent = 'running';

    const canvas = $('scope');
    const cx = canvas.getContext('2d');
    function drawScope() {
      analyser.getFloatTimeDomainData(buf);
      cx.clearRect(0,0,canvas.width,canvas.height);
      cx.beginPath();
      const H = canvas.height, W = canvas.width;
      const mid = H/2;
      for (let i=0;i<buf.length;i++) {
        const x = i / (buf.length-1) * W;
        const y = mid + buf[i]*mid*0.9;
        if (i===0) cx.moveTo(x,y); else cx.lineTo(x,y);
      }
      cx.strokeStyle = "#9aa4b5";
      cx.lineWidth = 1.5;
      cx.stroke();
      scopeTimer = requestAnimationFrame(drawScope);
    }
    drawScope();

    function tick() {
      analyser.getFloatTimeDomainData(buf);
      const { freq, rms } = detectPitchACF(buf, ctx.sampleRate);

      const open = rms >= Number($('gate').value);
      if (open !== gateOpen) setGate(open, ctx.currentTime);

      let base = freq;
      if (frozen && frozenHz > 0) base = frozenHz;
      else if (freq <= 0 || !isFinite(freq)) base = 0;
      else base = smooth(freq);

      base = clampOct(base);

      const semi = Number($('transpose').value);
      const trans = Math.pow(2, semi/12);
      base = base > 0 ? base * trans : 0;

      const ratios = ratioInputs.map(r => Number(r.value));
      const freqs = ratios.map(r => base * r);

      if (base > 0) {
        oscillators.forEach((osc, i) => {
          let f = Math.max(10, Math.min(20000, freqs[i]));
          oscGains[i].gain.value = muteInputs[i].checked ? 0 : Number(lvlInputs[i].value);
          try { osc.frequency.setTargetAtTime(f, ctx.currentTime, 0.02); }
          catch { osc.frequency.value = f; }
        });
      }

      updateUI(base || 0, freqs.map(f => base>0 ? f : NaN), rms);
      scriptTimer = requestAnimationFrame(tick);
    }
    tick();
  }

  function stop() {
    if (!started) return;
    started = false;
    $('start').disabled = false; $('stop').disabled = true;
    $('status').textContent = 'stopped';
    cancelAnimationFrame(scriptTimer);
    cancelAnimationFrame(scopeTimer);
    try { gateGain.disconnect(); master.disconnect(); micNode.disconnect(); comp.disconnect(); } catch {}
    try { oscillators.forEach(o => o.stop()); } catch {}
    oscillators = []; oscGains = []; panNodes = [];
    if (ctx && ctx.state !== 'closed') ctx.close();
  }

  $('start').onclick = start;
  $('stop').onclick = stop;

  $('gain').oninput = e => { if (master) master.gain.value = Number(e.target.value); $('gainVal').textContent = Number(e.target.value).toFixed(2); };
  $('smooth').oninput = e => { $('smoothVal').textContent = Number(e.target.value).toFixed(2); };
  $('gate').oninput = e => { $('gateVal').textContent = Number(e.target.value).toFixed(3); };
  $('attack').oninput = e => { $('attackVal').textContent = e.target.value; };
  $('release').oninput = e => { $('releaseVal').textContent = e.target.value; };

  $('transpose').oninput = e => { $('transposeVal').textContent = e.target.value; };

  const compMap = [
    ['compThr','threshold','compThrVal', v => Number(v)        ],
    ['compRatio','ratio','compRatioVal', v => Number(v)        ],
    ['compKnee','knee','compKneeVal', v => Number(v)           ],
    ['compAtk','attack','compAtkVal', v => Number(v)           ],
    ['compRel','release','compRelVal', v => Number(v)          ],
  ];
  compMap.forEach(([id, prop, vid, cast]) => {
    $(id).oninput = e => {
      const val = cast(e.target.value);
      $(vid).textContent = (prop==='attack'||prop==='release') ? Number(val).toFixed(3) : String(val);
      if (comp) comp[prop].value = val;
    };
  });

  $('freeze').onclick = () => {
    if (!started) return;
    frozen = true;
    // set frozenHz to latest displayed base if available
    const current = Number($('baseHz').textContent);
    if (isFinite(current) && current > 0) frozenHz = current;
    $('freeze').disabled = true; $('unfreeze').disabled = false;
  };
  $('unfreeze').onclick = () => {
    frozen = false;
    $('freeze').disabled = false; $('unfreeze').disabled = true;
  };

  panVals.forEach((s,i)=> s.textContent = Number(panInputs[i].value).toFixed(2));
  lvlVals.forEach((s,i)=> s.textContent = Number(lvlInputs[i].value).toFixed(2));

  document.addEventListener('click', () => { if (ctx && ctx.state === 'suspended') ctx.resume(); }, { once:false });
})();
</script>
</html>
